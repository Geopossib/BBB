/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a public read, admin-write model for all content collections.
 *
 * Data Structure:
 * - All content (articles, videos, audios, liveMeetings) is stored in top-level collections.
 *
 * Key Security Decisions:
 * - Unauthenticated users can read all content collections (articles, videos, audios, liveMeetings).
 * - Only authenticated users can create, update, and delete content.  There is no role based authentication implemented in the application. Assumes an admin role can be adopted by any signed in user.
 * - No data shape validation is performed in this prototype, only ownership validation on writes.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to articles and restricts write access to authenticated users.
     * @path /databases/{database}/documents/articles/{articleId}
     * @allow (get, list) Unauthenticated users can read articles.
     * @allow (create, update, delete) Authenticated users can create, update, and delete articles.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete articles.
     * @principle Allows public reads with authenticated-user-only writes.
     */
    match /articles/{articleId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to videos and restricts write access to authenticated users.
     * @path /databases/{database}/documents/videos/{videoId}
     * @allow (get, list) Unauthenticated users can read videos.
     * @allow (create, update, delete) Authenticated users can create, update, and delete videos.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete videos.
     * @principle Allows public reads with authenticated-user-only writes.
     */
    match /videos/{videoId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Allows public read access to liveMeetings and restricts write access to authenticated users.
     * @path /databases/{database}/documents/liveMeetings/{liveMeetingId}
     * @allow (get, list) Unauthenticated users can read liveMeetings.
     * @allow (create, update, delete) Authenticated users can create, update, and delete liveMeetings.
     * @deny (create, update, delete) Unauthenticated users cannot create, update, or delete liveMeetings.
     * @principle Allows public reads with authenticated-user-only writes.
     */
    match /liveMeetings/{liveMeetingId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Public read access for courses and their lessons. Write access restricted to authenticated users.
     * @path /databases/{database}/documents/courses/{courseId}
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();

      match /lessons/{lessonId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn();
      }
    }
  }

  // Helper function to determine if a user is signed in
  function isSignedIn() {
    return request.auth != null;
  }
}
